#vpath %.s Drivers/CMSIS/Device/ST/STM32L0xx/Source/Templates/gcc
#vpath %.c Drivers/CMSIS/Device/ST/STM32L0xx/Source/Templates
#vpath %.c Drivers/STM32L0xx_HAL_Driver/Src
#vpath %.c Src
#vpath %.h Drivers/CMSIS/Include
#vpath %.h Drivers/CMSIS/Device/ST/STM32L0xx/Include
#vpath %.h Drivers/STM32L0xx_HAL_Driver/Inc
#vpath %.h Inc


PROJECT		=ecode
TARGET_CHIP	=STM32L0
TARGET_BOARD	=NUCLEO_L073

GCC_PREFIX	=arm-none-eabi-

DEFS += -D USE_STDPERIPH_DRIVER
DEFS += -D STM32L073xx

TOP_DIR         =$(shell pwd)
OBJ_DIR         =$(TOP_DIR)/Obj
OUTPUT_DIR      =$(TOP_DIR)/Output
SCRIPT_DIR      =$(TOP_DIR)/scripts

TARGET_CHIP_DIR :=$(TOP_DIR)/targets/TARGET_$(TARGET_CHIP)
TARGET_BOARD_DIR        :=$(TARGET_CHIP_DIR)/$(TARGET_BOARD)

TARGET_ELF	=$(OUTPUT_DIR)/$(PROJECT)_$(TARGET_BOARD).elf
TARGET_BIN	=$(OUTPUT_DIR)/$(PROJECT)_$(TARGET_BOARD).bin
TARGET_HEX	=$(OUTPUT_DIR)/$(PROJECT)_$(TARGET_BOARD).hex

LDSCRIPT        =$(TARGET_CHIP_DIR)/$(TARGET_BOARD)/TOOLCHAIN_GCC_ARM/STM32L073RZ_FLASH.ld

OBJCPFLAGS_ELF_TO_BIN	=-Obinary
OBJCPFLAGS_ELF_TO_HEX	=-Oihex
OBJCPFLAGS_BIN_TO_HEX	=-Ibinary -Oihex


INC_DIR		+=-I $(TOP_DIR)/targets
INC_DIR		+=-I $(TARGET_CHIP_DIR)
INC_DIR		+=-I $(TARGET_CHIP_DIR)/CMSIS
INC_DIR		+=-I $(TARGET_CHIP_DIR)/common
INC_DIR		+=-I $(TARGET_CHIP_DIR)/$(TARGET_BOARD)
INC_DIR		+=-I $(TARGET_CHIP_DIR)/$(TARGET_CHIP)xx_HAL_Driver/Inc
INC_DIR		+=-I $(TOP_DIR)/platform
INC_DIR		+=-I $(TOP_DIR)/user
INC_DIR		+=-I $(TOP_DIR)/drivers
INC_DIR		+=-I $(TOP_DIR)/common

CC		:=$(GCC_PREFIX)gcc
AS		:=$(GCC_PREFIX)as
LD		:=$(GCC_PREFIX)ld
AR		:=$(GCC_PREFIX)ar
OBJCP		:=$(GCC_PREFIX)objcopy
OBJSIZE		:=$(GCC_PREFIX)size

CCFLAGS		+=-mcpu=cortex-m0plus	-mthumb -Wall -Os -ffunction-sections -fdata-sections -g -std=c99
LDFLAGS		+=-mcpu=cortex-m0plus	-mthumb

SOURCE		:=$(wildcard $(TARGET_CHIP_DIR)/*.c)
SOURCE		+=$(wildcard $(TARGET_CHIP_DIR)/CMSIS/*.c)
SOURCE		+=$(wildcard $(TARGET_CHIP_DIR)/common/*.c)
SOURCE		+=$(wildcard $(TARGET_CHIP_DIR)/$(TARGET_CHIP)xx_HAL_Driver/Src/*.c)
SOURCE		+=$(wildcard $(TOP_DIR)/platform/*.c)
SOURCE		+=$(wildcard $(TOP_DIR)/user/*.c)
SOURCE		+=$(wildcard $(TOP_DIR)/drivers/*.c)
SOURCE		+=$(wildcard $(TOP_DIR)/common/*c)
SOURCE_ASM	+=$(wildcard $(TARGET_CHIP_DIR)/$(TARGET_BOARD)/TOOLCHAIN_GCC_ARM/*.S)

C_OBJS		:=$(SOURCE:%.c=%.o)
ASM_OBJS	:=$(SOURCE_ASM:%.S=%.o)

.PHONY: all clean rebuild

all: $(TARGET_BIN) $(TARGET_ELF)

$(TARGET_BIN):$(TARGET_ELF)
	$(OBJCP) -O binary -S $< $@

$(TARGET_ELF):$(ASM_OBJS) $(C_OBJS)
	$(CC) $(LDFLAGS) $(addprefix $(OBJ_DIR)/,$(notdir $^)) -T $(LDSCRIPT) -o $@
	$(OBJSIZE) $@

$(C_OBJS):%.o:%.c
	$(CC) $(CCFLAGS) $(DEFS) $(INC_DIR) -c $^ -o  $(OBJ_DIR)/$(notdir $@)

$(ASM_OBJS):%.o:%.S
	$(CC) $(CCFLAGS) -c $^ -o $(OBJ_DIR)/$(notdir $@)


clean:
	${RM} $(OBJ_DIR)/* $(TARGET_BIN) $(TARGET_ELF) $(TARGET_HEX)

